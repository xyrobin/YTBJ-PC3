# 生产排产系统文档

## 业务逻辑
这是一个flask框架的生产排产的功能。将待排产的工单通过拖拽的方式排入未来的6个班次中。

上半部分是待排产的生产工单列表，每个工单包含工单号、所需工时、最早生产日期等信息。
下半部分是未来三天的6个班次，每次显示未来三天的日期，每天分为A、B这2个班次，每个班次12小时，A班早上8：00到晚上20：00，B班晚上20：00到次日8：00。展示每个班次的已排入工单的总工时和剩余工时。每个班次可以存放多条工单，不限总数量，只限总时间。

初始化：工单池内显示所有待排产（工单计划状态=0）的工单（按照最早生产日期升序动态排序），下半部分的每个班次里分别显示已经排入的工单（工单计划状态=0，PCRQ等于当前日期，并且班次BC等于当前班次）。

动态拖拽：工单池中的工单被拖入某个班次里（必须时未满12小时的班次）时，系统将数据库中该条工单的工单计划状态改为1，将排入的日期和班次分别写入BC、PCRQ字段。然后更新该班次的剩余工时。班次内的已排产工单有一个删除按钮，删除之后，工单也从班次中回到工单池，相应的数据库里也将排产状态改为0，并清空BC、PCRQ字段。

注意：如果工单被排入最早生产日期之前的班次中，或者工单的交货日期小于被拖入的班次日期，系统报警提示，用户确认后可以排入班次。
写入日期格式为“2025-06-09”，数据库的日期全部时字符串格式，不需要转换日期格式。
数据库是Oracle19，表 uf_SCGDWH。uf_SCGDWH表结构：SCGDH：生产工单号；GDJHZT：工单计划状态，0为待排产，排产完成后需要修改状态为1；JHRQ：交货日期；ZZSCRQ：最早生产日期；GSXS：所需工时。PCRQ：排产日期；BC：班次
项目结构：
/production_scheduling
│── app.py                # Flask主应用
│── models.py             # 数据模型和数据库操作
│── config.py             # 数据库配置
│── requirements.txt      # 依赖包
│── static/
│   │── style.css         # 样式表
│   │── sortable.js       # 拖拽库
│── templates/
│   │── index.html        # 主页面


### 1. 核心功能
- 工单池动态排序（按最早生产日期）
- 可视化班次工时统计（总工时/剩余工时）
- 跨班次拖拽排产（支持工单回收）
- 排产合法性校验（最早生产日期/交货日期）

### 2. 技术架构
```mermaid
flowchart TD
    A[前端] -->|AJAX| B[Flask应用]
    B -->|cx_Oracle| C[Oracle19]
    subgraph Frontend
        A["Vue.js + Sortable.js\n实时拖拽交互"]
    end
    subgraph Backend
        B["RESTful API\n工单状态管理\n排产逻辑校验"]
    end
```

### 3. API接口说明
#### 3.1 排产接口
```
POST /assign_order
请求参数：{"order_no": "SC202406001", "plan_date": "2024-06-10", "shift": "A"}

响应格式：
- 成功：{"success": true}
- 冲突：{"success": false, "message": "..."}
- 警告：{"success": "warning", "message": "..."}
```

### 4. 安装指南
```bash
# 创建虚拟环境
python -m venv .venv

# 安装依赖
pip install -r requirements.txt

# 数据库配置（修改config.py）
DB_HOST=192.168.0.100
DB_SERVICE=ORCL
DB_USER=*******
DB_PASSWORD=******
```

### 5. 待补充信息
<!-- 请在此区域补充以下内容 -->
- [ ] 压力测试报告：不需要压力测试，小型嵌入式应用，几乎不存在并发场景。
- [ ] 前端异常处理流程
- [ ] 数据库备份策略：另有系统外数据库备份，暂不考虑。
- [ ] 权限控制方案：暂不考虑。

## 技术实现

### 6. 关键算法
**班次容量计算**：
```python
def calculate_remaining_hours(scheduled_orders):
    total = sum(order['gsxs'] for order in scheduled_orders)
    return max(12 - total, 0)
```

### 7. 测试策略
| 测试类型 | 工具 | 覆盖率目标 |
|---------|------|------------|
| API测试 | pytest | 90%+       |
| E2E测试 | Cypress | 核心流程覆盖 |
| 负载测试 | Locust | 500并发    |

### 8. 安全注意事项
1. 数据库连接池大小限制（当前配置：10连接）
2. 输入参数SQL注入防护（使用参数化查询）
3. 日期格式严格校验（YYYY-MM-DD）

## 数据库规范

### 9. 排产状态流转
```mermaid
stateDiagram-v2
    [*] --> 待排产: 工单创建
    待排产 --> 已排产: 拖拽操作
    已排产 --> 待排产: 删除操作
```

### 10. 性能优化
- 工单池缓存机制（Redis待接入）
- 班次数据预加载（每日00:00刷新）
- 批量状态更新接口（待开发）

