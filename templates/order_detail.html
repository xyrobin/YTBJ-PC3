{% extends "base.html" %}

{% block content %}
<div class="order-detail-container">
    <h2 style="margin: 10px;">ç”Ÿäº§å·¥å•è¯¦æƒ…ï¼š<span class="scgdh"></span></h2>

    <div class="detail-card">
        <!-- åŸºç¡€ä¿¡æ¯åŒºå— -->
        <div class="detail-section">
            <h3>ğŸ“‹ å·¥å•æ¦‚è§ˆ </h3>
            <div class="detail-grid">
                <div class="grid-item">
                    <label>å®¢æˆ·åç§°ï¼š</label>
                    <span class="value khmc"></span>
                </div>
                <div class="grid-item">
                    <label>è®¡åˆ’çŠ¶æ€ï¼š</label>
                    <!-- ä¿®æ”¹HTMLéƒ¨åˆ†ï¼ˆç¬¬18è¡Œï¼‰ -->
                    <span class="status gdjhzt"></span>
                </div>
                <div class="grid-item">
                    <label>ä¸šåŠ¡å‘˜ï¼š</label>
                    <span class="value ywy"></span>
                </div>
                <div class="grid-item">
                    <label>åŠ å·¥å•ä½ï¼š</label>
                    <span class="value jgdw"></span>
                </div>
                <div class="grid-item">
                    <label>æœºç»„åç§°ï¼š</label>
                    <span class="value jzmc"></span>
                </div>
                <div class="grid-item">
                    <label>äº¤è´§æœŸï¼š</label>
                    <span class="value jhrq"></span>
                </div>
                <div class="grid-item">
                    <label>è®¡åˆ’å¼€å§‹æ—¶é—´ï¼š</label>
                    <span class="value jhksrq"></span>
                    <span class="value jhkssj"></span>
                </div>
                <div class="grid-item">
                    <label>ç­æ¬¡ï¼š</label>
                    <span class="value bc"></span>
                </div>
            </div>
        </div>

        <!-- æ—¶é—´ä¿¡æ¯åŒºå— -->
        <div class="detail-section">
            <h3>â° æ—¶é—´èŠ‚ç‚¹</h3>
            <div class="timeline">
                <div class="timeline-item sdgx-off">
                    <label>ä¸Šé“å·¥åºï¼š</label>
                    <span class="value sdgx"></span>
                </div>
                <div class="timeline-item">
                    <label>æœ€æ—©ç”Ÿäº§æ—¶é—´ï¼š</label>
                    <span class="value zzscrq"></span>
                    <span class="value zzscsj"></span>
                </div>
                <div class="timeline-item">
                    <label>è®¡åˆ’ç”Ÿäº§æ—¶é—´ï¼š</label>
                    <span class="value jhksrq"></span>
                    <span class="value jhkssj"></span>
                    <!-- æ·»åŠ æé†’å®¹å™¨ -->
                    <span class="time-warning"></span>
                </div>
                <div class="timeline-item">
                    <label>äº¤è´§æ—¶é—´ï¼š</label>
                    <span class="value jhrq"></span>
                    <span class="value jhsj"></span>
                </div>
                <div class="timeline-item xdgx-off">
                    <label>ä¸‹é“å·¥åºï¼š</label>
                    <span class="value xdgx"></span>
                </div>
            </div>
        </div>

        <!-- åŸæ–™ä¿¡æ¯åŒºå— -->
        <div class="detail-section">
            <h3>ğŸ“¦ åŸæ–™ä¿¡æ¯</h3>
            <div class="material-info">
                <div class="info-item">
                    <span class="label">åŸæ–™åº“ä½ï¼š</span>
                    <span class="value">{{ order.åŸæ–™åº“ä½ }}</span>
                </div>
                <div class="info-item">
                    <span class="label">åŸæ–™å¼ æ•°ï¼š</span>
                    <span class="value">{{ order.åŸæ–™å¼ æ•° }}</span>
                </div>
                <!-- å…¶ä»–åŸæ–™å­—æ®µ -->
            </div>
        </div>
    </div>
</div>
<script>
    window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const orderNo = urlParams.get('no');
        console.log(orderNo);
        // åœ¨æ•°æ®åŠ è½½å®Œæˆåæ‰§è¡Œæ—¶é—´æ ¡éªŒ


        // åœ¨fetchæˆåŠŸå›è°ƒä¸­è°ƒç”¨æ ¡éªŒå‡½æ•°
        fetch(`/api/order/${orderNo}`)
            .then(response => response.json())
            .then(data => {
                console.log(data)
                // console.log('è·å–åˆ°çš„è®¢å•æ•°æ®:', data[0], 'å…¶ä¸­khmcå­—æ®µå€¼ä¸º:', data[0].khmc?data[0].khmc:'æ— ');
                const order = data && data.length > 0 ? data[0] : null;
                console.log('è®¢å•æ•°æ®:', order);
                if (!order) {
                    document.getElementById('error-message').textContent = 'æœªæ‰¾åˆ°è®¢å•æ•°æ®';
                    return;
                }

                // å‘é¡µé¢å†™å…¥æ•°æ®
                function setText(className, value) {
                    // ä½¿ç”¨classé€‰æ‹©å™¨è·å–æ‰€æœ‰åŒ¹é…å…ƒç´ 
                    const elements = document.getElementsByClassName(className);
                    // éå†æ‰€æœ‰åŒ¹é…å…ƒç´ å¹¶è®¾ç½®å†…å®¹
                    Array.from(elements).forEach(element => {
                        element.innerText = value || '';
                    });
                }

                // åœ¨æ•°æ®ç»‘å®šéƒ¨åˆ†æ·»åŠ æ—¥æœŸæ—¶é—´æ‹†åˆ†é€»è¾‘
                Object.keys(order).forEach(key => {
                    // å¤„ç†æ—¥æœŸæ—¶é—´å­—æ®µï¼ˆæ‹†åˆ†æ—¥æœŸå’Œæ—¶é—´ï¼‰
                    if (['zzscrq', 'jhksrq', 'jhrq'].includes(key)) {
                        // const dateTime = order[key].split(' ');
                        // if (dateTime.length === 2) {
                        //     setText(key, dateTime[0]); // æ—¥æœŸéƒ¨åˆ†
                        //     setText(key.replace('rq', 'sj'), dateTime[1]); // æ—¶é—´éƒ¨åˆ†ï¼ˆå‡è®¾æ—¶é—´å­—æ®µæ˜¯rqæ›¿æ¢ä¸ºsjï¼‰
                        // }
                        setText(key, order[key]);
                    } else {
                        setText(key, order[key]);
                    }
                });


                // åŠ¨æ€è®¾ç½®çŠ¶æ€ç±»åï¼Œæ§åˆ¶æ˜¾ç¤ºæ ·å¼
                //å·¥å•æ’äº§çŠ¶æ€
                const statusElements = document.getElementsByClassName('gdjhzt');
                Array.from(statusElements).forEach(statusElement => {
                    if (order.gdjhzt) {
                        statusElement.className = statusElement.className.replace(/status-\S+/g, '').trim();
                        statusElement.classList.add(`status-${order.gdjhzt.replace(/\s+/g, '')}`);
                    }
                });
                //ä¸Šé“å·¥åº
                const sdgxElements = document.getElementsByClassName('sdgx-off');
                Array.from(sdgxElements).forEach(sdgxElements => {
                    if (order.sdgx) {
                        sdgxElements.className = sdgxElements.className.replace(/sdgx-\S+/g, '').trim();
                        sdgxElements.classList.add(`sdgx-on`);
                    }
                });
                //ä¸‹é“å·¥åº
                const xdgxElements = document.getElementsByClassName('xdgx-off');
                Array.from(xdgxElements).forEach(xdgxElements => {
                    if (order.xdgx) {
                        xdgxElements.className = xdgxElements.className.replace(/xdgx-\S+/g, '').trim();
                        xdgxElements.classList.add(`xdgx-on`);
                    }
                });

                // æ—¶é—´æ ¡éªŒ
                validateProductionTime(order);
            });

        // æ·»åŠ æ—¶é—´æ ¡éªŒ
        // ä¿®æ”¹è§£æå‡½æ•°ä»¥æ”¯æŒå®Œæ•´datetimeå­—ç¬¦ä¸²
        function parseDateTime(dateStr,timeStr) {

            if (!dateStr) return null;
            timeStr = timeStr || '23:59:59';
            // ç›´æ¥è§£æå®Œæ•´çš„æ—¥æœŸæ—¶é—´å­—ç¬¦ä¸²
            const dateTime = new Date(dateStr + ' ' + timeStr);
            // éªŒè¯æ—¥æœŸæœ‰æ•ˆæ€§
            return isNaN(dateTime.getTime()) ? null : dateTime;
        }

        function validateProductionTime(order) {
            // è·å–æ—¶é—´å…ƒç´ 
            const planDateEl = document.getElementsByClassName('jhksrq')[0];
            const planTimeEl = document.getElementsByClassName('jhkssj')[0];
            const warningEl = document.getElementsByClassName('time-warning')[0];

            // ä¿®æ”¹ï¼šç›´æ¥ä¼ å…¥å®Œæ•´datetimeå­—ç¬¦ä¸²
            const earliestDateTime = parseDateTime(order.zzscrq,order.zzscsj);
            const planDateTime = parseDateTime(order.jhksrq,order.jhkssj);
            const deliveryDateTime = parseDateTime(order.jhrq,order.jhsj);

            // æ·»åŠ è°ƒè¯•æ—¥å¿—
            console.log('æ—¶é—´è§£æç»“æœ:', {
                earliest: earliestDateTime,
                plan: planDateTime,
                delivery: deliveryDateTime
            });

            // é‡ç½®æ ·å¼å’Œè­¦å‘Š
            if (planDateEl && planTimeEl) {
                planDateEl.classList.remove('time-invalid');
                planTimeEl.classList.remove('time-invalid');
            }
            if (warningEl) warningEl.textContent = '';

            // æ—¶é—´æ ¡éªŒé€»è¾‘
            if (planDateTime && earliestDateTime && deliveryDateTime) {
                if (planDateTime < earliestDateTime) {
                    // è®¡åˆ’æ—¶é—´æ—©äºæœ€æ—©ç”Ÿäº§æ—¶é—´
                    if (planDateEl && planTimeEl) {
                        planDateEl.classList.add('time-invalid');
                        planTimeEl.classList.add('time-invalid');
                    }
                    if (warningEl) warningEl.textContent = 'è®¡åˆ’ç”Ÿäº§æ—¶é—´æ—©äºæœ€æ—©å¼€å§‹æ—¶é—´ï¼Œè¯·æ³¨æ„';
                } else if (planDateTime > deliveryDateTime) {
                    // è®¡åˆ’æ—¶é—´æ™šäºäº¤è´§æ—¶é—´
                    if (planDateEl && planTimeEl) {
                        planDateEl.classList.add('time-invalid');
                        planTimeEl.classList.add('time-invalid');
                    }
                    if (warningEl) warningEl.textContent = 'è®¡åˆ’ç”Ÿäº§æ—¶é—´æ™šäºäº¤è´§æ—¶é—´ï¼Œè¯·æ³¨æ„';
                }
            }
        }

    }
</script>
{% endblock %}