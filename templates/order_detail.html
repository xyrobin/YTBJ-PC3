{% extends "base.html" %}
{% block title %}æ™ºæ…§æ’äº§ä¸­å¿ƒ-å·¥å•è¯¦æƒ…{% endblock %}
{% block content %}
<div class="order-detail-container">
    <!-- <h2 style="margin: 10px;">ç”Ÿäº§å·¥å•è¯¦æƒ…ï¼š<span class="scgdh"></span></h2> -->
    <div class="order-header">
        <h2>å·¥å•è¯¦æƒ…ï¼š<span class="scgdh"></span><span class="badge jzmc-badge jzmc"></span>
            <button id="edit-btn" class="edit-button">ä¿®æ”¹ä¿¡æ¯</button>
            <button id="edit-gs-btn" class="edit-button">ä¿®æ”¹å·¥æ—¶</button>
        </h2>
    </div>

    <!-- æ·»åŠ æ¨¡æ€æ¡† -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3>ä¿®æ”¹å·¥å•ä¿¡æ¯</h3>
            <form id="edit-form">
                <div class="form-group">
                    <label for="jhrq">äº¤è´§æ—¥æœŸï¼š</label>
                    <input type="date" id="jhrq" name="jhrq">
                </div>
                <div class="form-group">
                    <label for="jhsj">äº¤è´§æ—¶é—´ï¼š</label>
                    <input type="time" id="jhsj" name="jhsj">
                </div>
                <div class="form-group">
                    <label for="zzscrq">æœ€æ—©ç”Ÿäº§æ—¥æœŸï¼š</label>
                    <input type="date" id="zzscrq" name="zzscrq">
                </div>
                <div class="form-group">
                    <label for="zzscsj">æœ€æ—©ç”Ÿäº§æ—¶é—´ï¼š</label>
                    <input type="time" id="zzscsj" name="zzscsj">
                </div>
                <div class="form-group">
                    <label for="jhbz">è®¡åˆ’å¤‡æ³¨ï¼š</label>
                    <textarea id="jhbz" name="jhbz" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="confirm-btn">ç¡®è®¤ä¿®æ”¹</button>
                    <button type="button" class="cancel-btn">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
    <!-- å·¥æ—¶ä¿®æ”¹æ¨¡æ€æ¡† -->
    <div id="edit-gs-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3>ä¿®æ”¹å·¥æ—¶</h3>
            <form id="edit-gs-form">
                <div class="form-group">
                    <label for="tzgs">å·¥æ—¶ï¼š</label>
                    <input type="number" id="tzgs" name="tzgs" step="0.5" required>
                </div>
                <div class="form-group">
                    <label for="gstzyy">å·¥æ—¶ä¿®æ”¹åŸå› ï¼š</label>
                    <textarea id="gstzyy" name="gstzyy" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="confirm-btn">ç¡®è®¤ä¿®æ”¹</button>
                    <button type="button" class="cancel-btn">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
    <div class="detail-card">
        <!-- åŸºç¡€ä¿¡æ¯åŒºå— -->
        <div class="detail-section">
            <h3>ğŸ“‹ å·¥å•æ¦‚è§ˆ </h3>
            <div class="detail-grid">
                <div class="grid-item">
                    <label>å®¢æˆ·åç§°ï¼š</label>
                    <span class="value khmc"></span>
                </div>
                <div class="grid-item">
                    <label>ä¸šåŠ¡å‘˜ï¼š</label>
                    <span class="value ywy"></span>
                </div>
                <div class="grid-item">
                    <label>åŠ å·¥å•ä½ï¼š</label>
                    <span class="value jgdw"></span>
                </div>
                <div class="grid-item">
                    <label>äº¤è´§æœŸï¼š</label>
                    <span class="value jhrq"></span>
                    <span class="value jhsj"></span>
                </div>
                <div class="grid-item">
                    <label>æœ€æ—©ç”Ÿäº§æ—¶é—´ï¼š</label>
                    <span class="value zzscrq"></span>
                    <span class="value zzscsj"></span>
                </div>
                <div class="grid-item">
                    <label>å·¥å•çŠ¶æ€ï¼š</label>
                    <!-- ä¿®æ”¹HTMLéƒ¨åˆ†ï¼ˆç¬¬18è¡Œï¼‰ -->
                    <span class="status gdzt"></span>
                </div>
                <div class="grid-item">
                    <label>è®¡åˆ’çŠ¶æ€ï¼š</label>
                    <!-- ä¿®æ”¹HTMLéƒ¨åˆ†ï¼ˆç¬¬18è¡Œï¼‰ -->
                    <span class="status gdjhzt"></span>
                </div>

                <div class="grid-item">
                    <label>ç­æ¬¡ï¼š</label>
                    <span class="value bc"></span>
                </div>
                <div class="grid-item">
                    <label>æ ‡å‡†å·¥æ—¶ï¼š</label>
                    <span class="value gs"></span>
                </div>
                <div class="grid-item">
                    <label>è®¡åˆ’å¤‡æ³¨ï¼š</label>
                    <span class="value jhbz"></span>
                </div>
            </div>
        </div>

        <!-- æ—¶é—´ä¿¡æ¯åŒºå— -->
        <div class="detail-section">
            <h3>â° æ—¶é—´èŠ‚ç‚¹</h3>
            <div class="timeline">
                <div class="timeline-item sdgx-off">
                    <label>ä¸Šé“å·¥åºï¼š</label>
                    <a href="" class="sdgx-link" target="_blank"><span class="value sdgx"></span></a>
                </div>
                <div class="timeline-item">
                    <label>æœ€æ—©ç”Ÿäº§æ—¶é—´ï¼š</label>
                    <span class="value zzscrq"></span>
                    <span class="value zzscsj"></span>
                </div>
                <div class="timeline-item">
                    <label>è®¡åˆ’ç”Ÿäº§æ—¶é—´ï¼š</label>
                    <span class="value jhksrq"></span>
                    <span class="value jhkssj"></span>
                    <!-- æ·»åŠ æé†’å®¹å™¨ -->
                    <span class="time-warning"></span>
                </div>
                <div class="timeline-item">
                    <label>è®¡åˆ’å®Œå·¥æ—¶é—´ï¼š</label>
                    <span class="value jhwgrq"></span>
                    <span class="value jhwgsj"></span>
                    <!-- æ·»åŠ æé†’å®¹å™¨ -->
                    <span class="time-warning"></span>
                </div>
                <div class="timeline-item">
                    <label>äº¤è´§æ—¶é—´ï¼š</label>
                    <span class="value jhrq"></span>
                    <span class="value jhsj"></span>
                </div>
                <div class="timeline-item xdgx-off">
                    <label>ä¸‹é“å·¥åºï¼š</label>
                    <a href="" class="xdgx-link" target="_blank"><span class="value xdgx"></span></a>
                </div>
                <div class="timeline-item">
                    <label>å®é™…å‘è´§æ—¶é—´ï¼š</label>
                    <span class="value fhrq"></span>
                    <span class="value fhsj"></span>
                </div>
            </div>
        </div>

        <!-- åŸæ–™ä¿¡æ¯åŒºå— -->
        <div class="detail-section">
            <h3>ğŸ“¦ åŸæ–™ä¿¡æ¯</h3>
            <div class="material-info">
                <div class="info-item">
                    <span class="label">åŸæ–™åº“ä½ï¼š</span>
                    <span class="value ylkw"></span>
                </div>
                <div class="info-item">
                    <span class="label">åŸæ–™å¼ æ•°ï¼š</span>
                    <span class="value ylzs"></span>
                </div>
                <div class="info-item">
                    <span class="label">åŸæ–™é‡é‡ï¼š</span>
                    <span class="value ylzl"></span>
                </div>
            </div>
        </div>

        <!-- äº§å“ä¿¡æ¯åŒºå— -->
        <div class="detail-section">
            <h3>ğŸ›ï¸ äº§å“ä¿¡æ¯</h3>
            <div class="material-info">
                <div class="info-item">
                    <span class="label">ç‰Œå·ï¼š</span>
                    <span class="value ph"></span>
                </div>
                <div class="info-item">
                    <span class="label">å“ç§åç§°ï¼š</span>
                    <span class="value pzmc"></span>
                </div>
                <div class="info-item">
                    <span class="label">å“ç§å¤§ç±»ï¼š</span>
                    <span class="value pzdl"></span>
                </div>
                <div class="info-item">
                    <span class="label">è§„æ ¼ï¼š</span>
                    <span class="value gg"></span>
                </div>
                <div class="info-item">
                    <span class="label">æˆå“å¼ æ•°ï¼š</span>
                    <span class="value cpzs"></span>
                </div>
                <div class="info-item">
                    <span class="label">å·¥è‰ºï¼š</span>
                    <span class="value gy"></span>
                </div>
                <div class="info-item">
                    <span class="label">è¡¨é¢ï¼š</span>
                    <span class="value bm"></span>
                </div>
                <div class="info-item">
                    <span class="label">è®¡åˆ’å¤‡æ³¨ï¼š</span>
                    <span class="value jhbz"></span>
                </div>
                <div class="info-item">
                    <span class="label">å¤‡æ³¨ï¼š</span>
                    <span class="value bz"></span>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const orderNo = urlParams.get('no');
        console.log(orderNo);
        // åœ¨æ•°æ®åŠ è½½å®Œæˆåæ‰§è¡Œæ—¶é—´æ ¡éªŒ


        // åœ¨fetchæˆåŠŸå›è°ƒä¸­è°ƒç”¨æ ¡éªŒå‡½æ•°
        // è·å–DOMå…ƒç´ 
        const editBtn = document.getElementById('edit-btn');
        const editGsBtn = document.getElementById('edit-gs-btn'); // æ–°å¢
        const modal = document.getElementById('edit-modal');
        const gsModal = document.getElementById('edit-gs-modal'); // æ–°å¢
        const closeBtn = document.querySelector('.close-btn');
        const cancelBtn = document.querySelector('.cancel-btn');
        const editForm = document.getElementById('edit-form');
        // æ–°å¢å·¥æ—¶æ¨¡æ€æ¡†å…ƒç´ 
        const gsCloseBtn = gsModal.querySelector('.close-btn');
        const gsCancelBtn = gsModal.querySelector('.cancel-btn');
        const gsEditForm = document.getElementById('edit-gs-form');
        let currentOrder = null;

        // åœ¨è·å–è®¢å•æ•°æ®åä¿å­˜å½“å‰è®¢å•å¯¹è±¡
        fetch(`/api/order/${orderNo}`)
            .then(response => response.json())
            .then(data => {
                console.log(data)
                //console.log('è·å–åˆ°çš„è®¢å•æ•°æ®:', data[0], 'å…¶ä¸­khmcå­—æ®µå€¼ä¸º:', data[0].khmc?data[0].khmc:'æ— ');
                //const order = data && data.length > 0 ? data[0] : null;
                window.order = data && data.length > 0 ? data[0] : null;

                console.log('è®¢å•æ•°æ®:', order);
                if (!order) {
                    document.getElementById('error-message').textContent = 'æœªæ‰¾åˆ°è®¢å•æ•°æ®';
                    return;
                }

                // å‘é¡µé¢å†™å…¥æ•°æ®
                function setText(className, value) {
                    // ä½¿ç”¨classé€‰æ‹©å™¨è·å–æ‰€æœ‰åŒ¹é…å…ƒç´ 
                    const elements = document.getElementsByClassName(className);
                    // éå†æ‰€æœ‰åŒ¹é…å…ƒç´ å¹¶è®¾ç½®å†…å®¹
                    Array.from(elements).forEach(element => {
                        element.innerText = value || '';
                    });
                }

                // åœ¨æ•°æ®ç»‘å®šéƒ¨åˆ†æ·»åŠ æ—¥æœŸæ—¶é—´æ‹†åˆ†é€»è¾‘
                Object.keys(order).forEach(key => {
                    // å¤„ç†æ—¥æœŸæ—¶é—´å­—æ®µï¼ˆæ‹†åˆ†æ—¥æœŸå’Œæ—¶é—´ï¼‰
                    // if (['zzscrq', 'jhksrq', 'jhrq'].includes(key)) {
                    //     setText(key, order[key]);
                    // } else {
                    //     setText(key, order[key]);
                    // }
                    setText(key, order[key]);
                });


                // åŠ¨æ€è®¾ç½®çŠ¶æ€ç±»åï¼Œæ§åˆ¶æ˜¾ç¤ºæ ·å¼
                //å·¥å•æ’äº§çŠ¶æ€
                const statusElements = document.getElementsByClassName('gdjhzt');
                Array.from(statusElements).forEach(statusElement => {
                    if (order.gdjhzt) {
                        statusElement.className = statusElement.className.replace(/status-\S+/g, '').trim();
                        statusElement.classList.add(`status-${order.gdjhzt.replace(/\s+/g, '')}`);
                    }
                });
                // æ–°å¢ï¼šæ ¹æ®å·¥å•çŠ¶æ€æ§åˆ¶ä¿®æ”¹æŒ‰é’®æ˜¾ç¤º
                if (order.gdjhzt === 'å·²æ’äº§') {
                    editBtn.style.display = 'none';
                    editGsBtn.style.display = 'none'; // åŒæ—¶éšè—å·¥æ—¶ä¿®æ”¹æŒ‰é’®
                }
                //ä¸Šé“å·¥åº
                const sdgxElements = document.getElementsByClassName('sdgx-off');
                Array.from(sdgxElements).forEach(sdgxElements => {
                    if (order.sdgx) {
                        sdgxElements.className = sdgxElements.className.replace(/sdgx-\S+/g, '').trim();
                        sdgxElements.classList.add(`sdgx-on`);
                    }
                });
                // å¤„ç†ä¸Šé“å·¥åºé“¾æ¥
                const sdgxLink = document.querySelector('.sdgx-link');
                if (sdgxLink) {
                    if (order.sdgx) {
                        // è®¾ç½®é“¾æ¥åœ°å€
                        sdgxLink.href = `/order?no=${encodeURIComponent(order.sdgx)}`;
                        sdgxLink.style.display = 'inline';
                    } else {
                        // æ— æ•°æ®æ—¶éšè—é“¾æ¥
                        sdgxLink.style.display = 'none';
                    }
                }
                //ä¸‹é“å·¥åº
                const xdgxElements = document.getElementsByClassName('xdgx-off');
                Array.from(xdgxElements).forEach(xdgxElements => {
                    if (order.xdgx) {
                        xdgxElements.className = xdgxElements.className.replace(/xdgx-\S+/g, '').trim();
                        xdgxElements.classList.add(`xdgx-on`);
                    }
                });
                // å¤„ç†ä¸‹é“å·¥åºé“¾æ¥
                const xdgxLink = document.querySelector('.xdgx-link');
                if (xdgxLink) {
                    if (order.xdgx) {
                        // è®¾ç½®é“¾æ¥åœ°å€
                        xdgxLink.href = `/order?no=${encodeURIComponent(order.xdgx)}`;
                        xdgxLink.style.display = 'inline';
                    } else {
                        // æ— æ•°æ®æ—¶éšè—é“¾æ¥
                        xdgxLink.style.display = 'none';
                    }
                }

                // æ—¶é—´æ ¡éªŒ
                validateProductionTime(order);

            });



        // æ·»åŠ æ—¶é—´æ ¡éªŒ
        function parseDateTime(dateStr, timeStr) {

            if (!dateStr) return null;
            timeStr = timeStr || '23:59:59';
            // ç›´æ¥è§£æå®Œæ•´çš„æ—¥æœŸæ—¶é—´å­—ç¬¦ä¸²
            const dateTime = new Date(dateStr + ' ' + timeStr);
            return isNaN(dateTime.getTime()) ? null : dateTime;
        }

        function validateProductionTime(order) {
            // è·å–æ—¶é—´å…ƒç´ 
            const planDateEl = document.getElementsByClassName('jhksrq')[0];
            const planTimeEl = document.getElementsByClassName('jhkssj')[0];
            const planEndDateEl = document.getElementsByClassName('jhwgrq')[0];
            const planEndTimeEl = document.getElementsByClassName('jhwgsj')[0];
            const earlyWarningEl = document.getElementsByClassName('time-warning')[0];
            const lateWarningEl = document.getElementsByClassName('time-warning')[1];
            //åˆ›å»ºæ—¶é—´å˜é‡
            const earliestDateTime = parseDateTime(order.zzscrq, order.zzscsj);
            const planDateTime = parseDateTime(order.jhksrq, order.jhkssj);
            const planEndDateTime = parseDateTime(order.jhwgrq, order.jhwgsj);
            const deliveryDateTime = parseDateTime(order.jhrq, order.jhsj);

            // æ·»åŠ è°ƒè¯•æ—¥å¿—
            console.log('æ—¶é—´è§£æç»“æœ:', {
                earliest: earliestDateTime,
                plan: planDateTime,
                planEnd: planEndDateTime,
                delivery: deliveryDateTime
            });

            // é‡ç½®æ ·å¼å’Œè­¦å‘Š
            if (planDateEl && planTimeEl) {
                planDateEl.classList.remove('time-invalid');
                planTimeEl.classList.remove('time-invalid');
            }
            if (planEndDateEl && planEndTimeEl) {
                planEndDateEl.classList.remove('time-invalid');
                planEndTimeEl.classList.remove('time-invalid');
            }
            if (earlyWarningEl) earlyWarningEl.textContent = '';
            if (lateWarningEl) lateWarningEl.textContent = '';

            // æ—¶é—´æ ¡éªŒé€»è¾‘
            if (planDateTime && earliestDateTime && planEndDateTime && deliveryDateTime) {
                if (planDateTime < earliestDateTime) {
                    // è®¡åˆ’æ—¶é—´æ—©äºæœ€æ—©ç”Ÿäº§æ—¶é—´
                    if (planDateEl && planTimeEl) {
                        planDateEl.classList.add('time-invalid');
                        planTimeEl.classList.add('time-invalid');
                    }
                    if (earlyWarningEl) earlyWarningEl.textContent = 'è®¡åˆ’ç”Ÿäº§æ—¶é—´æ—©äºæœ€æ—©å¼€å§‹æ—¶é—´ï¼Œè¯·æ³¨æ„';
                } else if (planEndDateTime > deliveryDateTime) {
                    // è®¡åˆ’æ—¶é—´æ™šäºäº¤è´§æ—¶é—´
                    if (planEndDateEl && planEndTimeEl) {
                        planEndDateEl.classList.add('time-invalid');
                        planEndTimeEl.classList.add('time-invalid');
                    }
                    if (lateWarningEl) lateWarningEl.textContent = 'è®¡åˆ’å®Œå®Œå·¥æ—¶é—´æ™šäºäº¤è´§æ—¶é—´ï¼Œè¯·æ³¨æ„';
                }
            }
        }

        // å¡«å……ç¼–è¾‘è¡¨å•
        function populateEditForm(order) {
            console.log('è°ƒç”¨ç¼–è¾‘æ¡†åˆå§‹å€¼æ–¹æ³•');
            document.getElementById('jhrq').value = order.jhrq || '';
            document.getElementById('jhsj').value = order.jhsj || '';
            document.getElementById('zzscrq').value = order.zzscrq || '';
            document.getElementById('zzscsj').value = order.zzscsj || '';
            document.getElementById('jhbz').value = order.jhbz || '';
        }
        // å¡«å……å·¥æ—¶ç¼–è¾‘è¡¨å•
        function populateGsEditForm(order) {
            console.log('è°ƒç”¨å·¥æ—¶ç¼–è¾‘æ¡†åˆå§‹å€¼æ–¹æ³•');
            document.getElementById('tzgs').value = order.tzgs || '';
            document.getElementById('gstzyy').value = order.gstzyy || '';
        }

        // æ‰“å¼€æ¨¡æ€æ¡†
        editBtn.onclick = function () {
            modal.style.display = 'block';
            //ç¼–è¾‘æ¡†èµ‹å€¼
            populateEditForm(order);
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            modal.style.display = 'none';
        }

        closeBtn.onclick = closeModal;
        cancelBtn.onclick = closeModal;

        // æ–°å¢ï¼šå·¥æ—¶æ¨¡æ€æ¡†æ§åˆ¶
        editGsBtn.onclick = function () {
            gsModal.style.display = 'block';
            populateGsEditForm(order); // å¡«å……å·¥æ—¶è¡¨å•
        }

        // å…³é—­å·¥æ—¶æ¨¡æ€æ¡†
        function closeGsModal() {
            gsModal.style.display = 'none';
        }

        gsCloseBtn.onclick = closeGsModal;
        gsCancelBtn.onclick = closeGsModal;




        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function (event) {
            if (event.target == modal) {
                closeModal();
            }
        }
        window.onclick = function (event) {
            if (event.target == gsModal) {
                closeGsModal();
            }
        }

        // ä¿¡æ¯ä¿®æ”¹è¡¨å•æäº¤å¤„ç†
        editForm.onsubmit = function (e) {
            e.preventDefault();

            // æ”¶é›†è¡¨å•æ•°æ®
            const formData = {
                scgdh: orderNo, // å·¥å•å·ï¼Œç”¨äºæ ‡è¯†æ›´æ–°å“ªä¸ªè®¢å•
                jhrq: document.getElementById('jhrq').value,
                jhsj: document.getElementById('jhsj').value,
                zzscrq: document.getElementById('zzscrq').value,
                zzscsj: document.getElementById('zzscsj').value,
                jhbz: document.getElementById('jhbz').value
            };

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading();

            // è°ƒç”¨æ›´æ–°æ¥å£
            fetch('/api/update_order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('æ›´æ–°å¤±è´¥');
                    }
                    return response.json();
                })
                .then(data => {
                    // éšè—åŠ è½½çŠ¶æ€
                    hideLoading();

                    if (data.success) {
                        alert('æ›´æ–°æˆåŠŸï¼');
                        closeModal();
                        // æ›´æ–°é¡µé¢æ˜¾ç¤ºçš„æ•°æ®
                        // Object.assign(currentOrder, formData);
                        // bindOrderData(currentOrder);
                        // validateProductionTime(currentOrder);
                        location.reload();
                    } else {
                        alert('æ›´æ–°å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    if (error) {
                        hideLoading();
                        console.error('æ›´æ–°é”™è¯¯:', error.toString());
                        alert('æ›´æ–°æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
                    }
                });


        };
        // å·¥æ—¶ä¿¡æ¯ä¿®æ”¹è¡¨å•æäº¤å¤„ç†
        gsEditForm.onsubmit = function (e) {
            e.preventDefault();
            // æ”¶é›†è¡¨å•æ•°æ®
            const gsFormData = {
                scgdh: orderNo,
                tzgs: document.getElementById('tzgs').value,
                gstzyy: document.getElementById('gstzyy').value
            };

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading();

            // è°ƒç”¨æ›´æ–°æ¥å£
            fetch('/api/update_order_gs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(gsFormData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('æ›´æ–°å¤±è´¥');
                        alert('æ›´æ–°å¤±è´¥');
                    }
                    return response.json();
                })
                .then(data => {
                    // éšè—åŠ è½½çŠ¶æ€
                    hideLoading();

                    if (data.success) {
                        alert('æ›´æ–°æˆåŠŸï¼');
                        closeGsModal();
                        // æ›´æ–°é¡µé¢æ˜¾ç¤ºçš„æ•°æ®
                        // Object.assign(currentOrder, formData);
                        // bindOrderData(currentOrder);
                        // validateProductionTime(currentOrder);
                        location.reload();
                    } else {
                        alert('æ›´æ–°å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    if (error) {
                        hideLoading();
                        console.error('æ›´æ–°é”™è¯¯:', error.toString());
                        alert('æ›´æ–°æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
                    }
                });
        }


    };

    // æ·»åŠ åŠ è½½çŠ¶æ€æ§åˆ¶å‡½æ•°
    function showLoading() {
        // åˆ›å»ºåŠ è½½é®ç½©å±‚
        const loading = document.createElement('div');
        loading.className = 'loading-overlay';
        loading.innerHTML = '<div class="loading-spinner"></div><div class="loading-text">å¤„ç†ä¸­...</div>';
        document.body.appendChild(loading);
    }

    function hideLoading() {
        // ç§»é™¤åŠ è½½é®ç½©å±‚
        const loading = document.querySelector('.loading-overlay');
        if (loading) loading.remove();
        window.location.reload();
    }
</script>
{% endblock %}